# Mysql 소개
Mysql은 오픈소스 데이터베이스이며 Mysql은 스웨덴의 TcX라는 회사의 터미널 인터페이스 라이브러리인 UNIREG로 부터 시작이 되었다.

현재 MysSQL 라이선스 정책은 'Mysql 엔터프라이즈 에디션' 과 'MySQL 커뮤니티 에디션' 으로 두 가지 이며, 별도의 라이선스 계약 없이 일반 사용자가 내려받아 사용하는 버전은 'MySQL
커뮤니티 에디션' 이다.

## 왜 MySQL 인가?
> 다른 DBMS와 비교할 때 MySQL의 경쟁력은 무엇이고 왜 MySQL을 사용해야 할까 ?
>
- 안전성
- 성능과 기능
- 커뮤니티나 인지도
  _"자기가 가장 잘 활용 할 수 있는 DBMS가 가장 좋은 DBMS 이다"_

# MySQL 설치

## MySQL 서버 설치
> MySQL 서버는 다양한 형태로 설치 할 수 있지만 가능하면 리눅스의 RPM 이나 운영체제 별 인스톨러를 이용하기를 권장한다
- Tar 또는 Zip으로 압축된 버전
- 리눅스 RPM 설치 버전(윈도우 인스톨러 및 macOS 설치 패키지)
- 소스코드 빌드

## 버전과 에디션(엔터프라이즈와 커뮤니티 선택)
> MySQL 서버의 버전을 선택할 땐 다른 제약 사항이 없으면 가능한 한 최신 버전을 설치하는 것이 좋다.
>
- 기존 버전에서 새로운 메이저 버전(MySQL 5.1, 5.5, 5.6, 5.7, 8.0) 으로 업그레이드 하는 경우엔 최소 패치 버전이 15~20번 이상 릴리스된 버전을 선택하는 것이 안정적인 서비스에
  도움이 된다.
    1. ex ) mysql 8.0 버전이면 -> 8.0.15 부터 20 버전 사이 버전을 선택해라
- 갓 출시된 메이저 버전을 선택하는 것은 조금 위험하다. 메이저 버전은 많은 변화를 거친 버전이므로 버그가 발생 될 확률이 높다.
- 엔터프라이즈 에디션과 커뮤니티 에디션의 핵심 기능은 거의 차이가 없다.(특정 부가 기능들만 상용 버전인 엔터프라이즈 에디션에 포함됌)
    - 엔터프라이즈의 부가적인 기능
        1. Thread Pool
        2. Enterprise Audit
        3. Enterprise TDE(Master Key 관리)
        4. Enterprise Authentication
        5. Enterprise Firewall
        6. Enterprise Monitor
        7. Enterprise Backup
        8. MySQL 기술 지원
- 엔터파이즈에서 지원하는 부가적인 기능들은 `Percona` 에서 지원하는 플러그인을 통해서 MySQL 커뮤니티 에디션의 부족한 부분들을 매꿀 수 있다.
- 엔터프라이즈와 커뮤니티는 성능적으로는 다르진 않으며 엔터프라이즈를 선택할 땐 꼭 필요한지 검토해라

## MySQL 설치
- 리눅스 서버의 Yum 인스톨러 설치
- Yum 인스톨러 없이 RPM 파일로 설치
- macOS용 DMG 패키지 설치

### MySQL 서버 디렉토리 경로 설명
> 책에서 macOS용 DMG 패키지 설치를 기준으로 설명합니다.
- MySQL 서버 설치 경로 : `/usr/local/mysql` (아래는 하위 각 디렉터리 정로)
    1. bin: MySQL 서버와 클라이언트 프로그램, 유틸리티를 위한 디렉터리
    2. data: 로그 파일과 데이터 파일들이 저장되는 디렉터리
    3. include: C/C++ 헤더 파일들이 저장된 디렉터리
    4. lib: 라이브러리 파일들이 저장된 디렉터리
    5. share: 다양한 지원 파일들이 저장돼 있으며, 에러 메시지나 샘플 설정 파일(my.cnf)이 있는 디렉터리
### MySQL 서버 실행 명령어 (macOS)
```shell
sudo /usr/local/mysql/support-files/mysql.server start
sudo /usr/local/mysql/support-files/mysql.server stop 
```
### 에러 로그 파일 기록
- `--initialize-insecure` 옵션을 사용해서 서버를 실행하게 되면 초기 데이터 파일과 로그 파일들을 생성하고 마지막으로 비밀번호가 없는 관리자 계정인 root 유저를 생성한다.
- 비밀번호가 없는 관리자 계정을 만들땐 `--initialize` 옵션을 사용하자 이후 관리자 계정의 에러 로그 파일을 기록하게 된다.
- 에러 로그 파일의 기본 경로 : `/var/log/mysqld.log`

### 원격 서버 셧다운
```shell
mysql> SHUTDOWN;
```
- MySQL 서버에 로그인 된 상태에서 명령어를 쳐야하며 원격으로 셧다운할려면 권한(Privileges)을 가지고 있어야 한다.
- MySQL 서버는 실제 트랜잭션이 정상적으로 커밋돼도 데이터 파일에 변경된 내용이 기록되지 않고 로그파일에만 기록돼 있을 수 있고, 서버를 재시작 하여도 똑같은 상태로 남아 있을 수 있는데 이는 결코
  비정상적인 상황이 아니다.
- 서버가 종료되고 나서 모든 커밋된 내용을 데이터 파일에 기록하고 종료하는 옵션
    ```shell
    mysql> SET GLOBAL innodb_fast_shutdown=0;
    mysql> SHUTDOWN;
    ```
- 서버가 시작되거나 종료될 때는 서버의 버퍼 풀 내용을 백업하고 복구하는 과정이 내부적으로 실행된다.
- 실제 버퍼 풀의 내용을 백업하는 것이 아닌, 버퍼 풀에 적재돼 있던 데이터파일의 데이텉 페이지에 대한 메타 정보를 백업하기 때문에 용량이 크지 않으며, 백업 자체는 매우 빠르게 완료된다.
- 서버가 새로 시작될 때는 디스크에서 데이터 파일들을 모두 읽어서 적재해야 하므로 시간이 오래 걸리는 현상이 발생한다.

### 서버 연결 테스트
```shell
linux> mysql -uroot -p --host=localhost --socket=/tmp/mysql.sock 
linux> mysql -uroot -p --host=127.0.0.1 --port=3306
linux> mysql -uroot -p 
```
- 첫번째 명령어는 소켓 파일을 이용해서 접속하는 예
- 두번째는 TCP/IP를 통해 호스트로 접속하는 예
- 처음 설치된 MySQL 서버는 root라는 관리자 계정이 준비돼 있으며, `--initialize-insecure` 옵션으로 MySQL 서버가 초기화됐다면 비밀번호 없이 로그인할 수 있다.
    - 만약 `--initialize` 옵션으로 초기화돼면 MySQL 서버의 로그 파일에 기록돼 있는 비밀번호를 이용해서 로그인하면 된다.


## MySQL 서버 업그레이드
- MySQL 서버의 데이터 파일을 그대로 두고 업그레이드하는 방법(인플레이스 업그레이드)
- mysqldump 도구 등을 이용해 MySQL 서버의 데이터를 SQL 문장이나 텍스트 파일로 덤프한 후, 새로 업그레이드된 버전의 MySQL 버전의 MySQL 서버에서 덤프된 데이터를 적재하는 방법
  (논리적 업그레이드)

### 인플레이스 업그레이드
> 동일 메이저 버전에서 마이너 버전 간 업그레이드는 대부분 데이터 파일의 변경 없이 진행된다.
- MySQl 8.0.16  버전에서 8.0.21 버전으로 업그레이드 할 떄는 MySql 서버 프로그램만 재설치하면 된다
- 메이저 버전 간 업그레이드는 대부분 크고 작은 데이터 파일의 변경이 필요하기 때문에 반드시 직전 버전에서만 업그레이드가 허용된다.
    1. ex) 5.5 -> 5.6 (o), 5.5 -> 5.7 8.0 (x 한 단계 건너뛰거나 두 단계 건너뛰는 업그레이드는 지원하지 않는다.)
- 두 단계 이상을 한 번에 업그레이드 할 경우엔 mysqldump 프로그램으로 MySQL 서버에서 데이터를 백업받은 후 새로 구축된 MySQL 8.0 서버에 데이터를 적재하는 `논리적 업그레이드`가 더 나은
  방법이다.
- 메이저 버전 업그레이드가 특정 마이너버전에서만 가능 하다.
    - GA 버전을 확인해라 (GA 버전은 오라클에서 MySQL 서버의 안전성이 확인된 버전이다.)
    - 새로운 버전의 MySQl 서버를 선택할 땐 최소 GA 버전은 지나서 15~20번 이상의 마이너 버전을 선택하는 것이 좋다.
    - 특정 경우엔 메이저버전에서도 가장 최근의 마이너 버전에서만 인플레이스 업그레이드가 지원될 수도 있다.
- 항상 메이저 버전 업그레이드 할 땐 MySQL 서버의 메뉴얼을 정독해라


### MySQL 8.0 업그레이드 고려 사항
> MySQl 8.0 은 5.7 보다 많은 기능들이 개선되거나 변경됌
- 사용자 인증 방식 변경
    - 기존 5.7에서는 Native Authentication 인증 방식을 사용했는데, 8.0 에서는 별도의 옵션 없이 생성되는 사용자 계정은 `Caching SHA-2 Authentication`으로 바뀌었다.
        - 만일, 8.0에서 Native Authentication을 사용하고 싶을땐 `--default-authentication-plugin=mysql_native_password` 파라미터를 활성화해라
- MySQL 8.0 과 호환성 체크
    - 5.7 버전에서 손상된 FRM 파일이나 호환되지않는 데이터 타입 또는 함수가 있는지 mysqlcheck 유틸리티를 통해 확인해 볼 것을 권장한다 .
- 외래키 이름의 길이
    - 8.0 에서는 외래키의 이름이 64 글자로 제한된다 . 그래서 기존의 MySQL 서버에서 외래키 이름이 64글자 이상인 것이 있는지 확인하고 필요하면 변경해라
- 인덱스 힌트
    - MySQL 5.x 에서 사용되던 인덱스 힌트가 있다면 8.0에서 먼저 성능 테스트를 수행하자
        - 5.x에서는 성능 향상에 도움이 됐지만 8.x에서는 오히려 성능 저하를 유발할 수도 있다.
- GROUP BY 에 사용된 정렬 옵션
    - 5.x에서는 GROUP BY 절의 컬럼 뒤에 'ASC' 나 'DESC'를 사용하고 있다면 제거하거나 다른 방식으로 변경해라
- 파티션을 위한 공용 테이블스페이스
    - MySQL 8.x에서는 파티션의 각 테이블스페이스를 공용 테이블스페이스에 저장할 수 없다. 그래서 파티션의 테이블스페이스가 공용 테이블스페이스에 저장된 것이 있는지 먼저 확인하고 수정해라.
        - `ALTER TABLE ... REORGANIZE` 명령을 실행해 개별 테이블스페이스를 사용해서 변경해라


### MySQL 8.0 업그레이드
> 5.7에서 8.0으로 업그레이드하는 과정은 MySQL 서버가 내부적으로 진행하는 업그레이드 과정이 상당히 복잡하다.
>
- 5.7에서 8.0 으로 업그레이드할때 크게 두 가지 단계로 나뉘어서 처리 됌
    1. 데이터 딕셔너리 업그레이드: 5.7 버전에서는 딕셔너리 정보가 FRM 확장자를 가진 파일을 별도로 보관됐었는데, 8.0 버전에서는 딕셔너리 정보가 트랜잭션이 지원되는 InnoDB 테이블로 저장되도록
       개선되었다. 8.0 부터는 딕셔너리 데이터의 버전 간 호환성 관리를 위해 테이블이 생성될 때 사용된 MySQL 서버의 버전 정보도 함께 기록한다.
- 서버 업그레이드
    - MySQl 서버의 시스템 데이터베이스(performance_schema와 information_schema 그리고 mysql 데이터베이스)의 테이블 구조를 MySQL 8.0 버전에 맞게 변경한다

### MySQL 업그레이드 순서 8.0.15 이하 버전
> 5.7 버전에서 8.0.15 이하 버전으로 업그레이드 할 때 절차
- MySQL 셧다운
- 5.7 프로그램 삭제
- 8.0 프로그램 설치
- 서버(mysqld) 시작(mysql 서버가 데이터 딕셔너리 업그레이드를 자동 실행)
- mysql_upgrade 프로그램 실행(mysql_upgrade 프로그램이 시스템 테이블의 구조를 8.0에 맞게 변경)
### 8.0.16 이상 버전
> mysql_upgrade 유틸리티가 없어지고 서버 프로그램이 시작되면서 모든 업그레이드 작업이 '데이터 딕셔너리 업그레이드' 와 '서버 업그레이드' 를 순서대로 실행한다
- MySQL 셧다운
- 5.7 삭제
- 8.0 설치
- 8.0 서버 (mysqld) 시작 (mysql 서버가 대이터 딕셔너리 업그레이드를 실행 후, 시스템 테이블 구조를 8.0에 맞게 변환)


### 서버 설정
> 일반적으로 MySQl 서버는 단 하나의 설정 파일을 사용한다. 리눅스를 포함한 유닉스 계열은 my.cnf 이름을 사용하고 윈도우 계열은 my.ini 라는 이름을 사용한다.
- mysql 서버는 지정된 여러 개의 디렉터리를 순차적으로 탐색하면서 처음 발견된 my.cnf 파일을 사용한다.
- 직접 mysql을 컴파일해서 설치하는 경우에는 이 디렉터리가 다르게 설정될 수 있다.
#### my.cnf 파일 경로 확인
```shell
mysqld --verbosse --help
...
Default options are read from the follwing files in the given order:
/etc/my.cnf /etc/mysql/my.cnf /usr/etc/my.cnf ~/.my.cnf
```
- 위 명령어는 다음과 같은 순서로 파일을 찾느다
    1. /etc/my.cnf
    2. /etc/mysql/my.cnf
    3. /usr/etc/my.cnf
    4. ~/.my cnf

_여러 곳에서 my.cnf 파일을 만들어서 사용하면 서버가 어느 디렉터리 의 my.cnf 파일을 참조했는지 알아내기 쉽지 않다. 이러한 경우에 위 예제의 명령으로 mysql 서버가 어느 디렉터리의 my.cnf
파일을 먼저 읽는지(우선순위) 를 확인할 수 있다._


### 설정 파일의 구성
> mysql 설정 파일은 하나의 my.cnf나 my.ini 파일에 여러 개의 설정 그룹을 담을 수 있고 대체로 실행  프로그램 이름을 그룹명으로 사용한다
>
```shell
[mysqld_safe]
malloc-lib = ...

[mysqld]
socket = /usr/local ...
port = 3306

[mysql]
default-character-set =utf8mb4
socket = /usr/local ..
```
- 위 코드 예제 처럼  mysql 프로그램은 설정 그룹의 이름이 [이름(mysqld, mysql)] 영역을 참조한다.
- mysql 서버만을 위한 설정이면 [mysqld] 그룹만 명시해도 된다
- 일반적으로 각 그룹을 사용하는 프로그램은 성격이 다르고 각 프로글램이 필요로 하는 설정 내용이 상이하므로 중복되는 설정이 나열 되는 경우는 거의 없지만 socket이나 port 같은 설정은 모든 프로그램에
  공통으로 필요한 설정값이다.
- 백업을 위한 mysqldum 프로그램이 실행될 때도 공용으로 사용하고 싶다면 [mysql] 또는 [mysqldump]등의 그룹을 함께 설정해 둘 수 있다.


### MySQl 시스템 변수의 특징
- mysql 서버는 기둥하면서 설정 파일의 내용을  읽어 메모리나 작동 방식을 초기화하고, 접속된 사용자를 제어하기 위해 별도의 값을 저장해 둔다.
- 별도의 시스템 변수 값을 확인하는 방법
```shell
mysql> SHOW GLOBAL VARIABLES;
```
![스크린샷 2023-12-21 오후 7.54.13.png](..%2F..%2F%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202023-12-21%20%EC%98%A4%ED%9B%84%207.54.13.png)
![스크린샷 2023-12-21 오후 7.54.01.png](..%2F..%2F%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202023-12-21%20%EC%98%A4%ED%9B%84%207.54.01.png)

#### 시스템 변수가 가지는 5가지 속성
> https://dev.mysql.com/doc/refman/8.0/en/server-system-variable-referece.html 여기서 시스템 변수를 나타내는 다양한 변수가 존재한다 여기서는 말하는건 일부를 설명한다
>
![스크린샷 2023-12-21 오후 7.54.43.png](..%2F..%2F%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202023-12-21%20%EC%98%A4%ED%9B%84%207.54.43.png)
- Cmd-Line: 서버의 명령행 인자로 설정될 수 있는지 여부를 나타낸다.
- Option file: MySQl의 설정 파일인 my.cnf 로 제어할 수 있는지 여부를 나타낸다. 옵션 파일이나 설정 파일 또는 컨피규레이션 파일 등은 전부 my.cnf 파일을 지칭한다
- System Var: 시스템 변수인지 아닌지 나타낸다. 8.0에서는 모든 시스템 변수들이 '_'를 구분자로 사용하도록 되어있다.
- Var Scope: 시스템 변수의 적용 범위를 나타낸다. 이 시스템 변수가 영향을 미치는 곳이 MySQL 서버 전체를 대상으로 하는지 아니면 MySQL 서버와 클라이언트 간의 커넥션만인지 구분한다. 그리고
  어떤 변수는 세션과 글로벌 범위에 모두 적용 되기도 한다.
- Dynamic: 시스템 변수가 동적인지 정적인지 구분하는 변수이다.


### 글로벌 변수와 세션 변수
> mysql 시스템 변수는 적용 범위에 따라 글로벌 변수오아 세션변수로 나뉘는데 일반적으로 세션별로 적용되는 시스템 변수의 경우 글로벌 변수뿐만 아니라 세션 변수에도 동시에 존재한다. 이러한 경우 'Var
Scope' 'Both' 라고 표현된다

- 글로벌 범위의 시스템 변수는 하나의 mysql 서버 인스턴스에서 전체적으로 영향을 미치는 시스템 변수를 의미하고 주로 mysql 서버 자체에 관련된 설정일 때가 많다. mysql 서버에서 단 하나만
  존재하는 InnoDB 버퍼 풀 크기 또는 MyISAM의 키 캐시 크기 등이 가장 대표적인 글로벌 영역의 시스템 변수이다
- 세션 범위의 시스템 변수는 mysql 클라이언트가 mysql 서버에 접속할때 기본으로 부여하는 옵션의 기본값을 제어하는 데 사용된다
  기본 값은 글로벌 시스템 변수이며 클라이언트가 가지는 값이 세션 시스템 변수이다.
    - 세션 변수는 커넥션별로 설정값을 서로 다르게 지정할 수 있으며, 한번 연결된 커넥션의 세션 변수는 서버에서 강제로 변경할 수 없다.
- 세션 범위의 시스템 변수 가운데 mysql 서버 설정 파일(my.cnf, ini)에 명시해 초기화할 수 있는 변수는 대부분 범위가 'Both'로 되어있는데 명시된 시스템 변수는 mysql 서버가 기억만
  하고 있다가 실제 클라이언트와의 커넥션이 생성되는 순간에 해당 커넥션의 기본값으로 사용되는 값이다. 그리고 순수하게 범위가 세션(Session)이라고 명시된 시스템 변수는 mysql 서버의 설정 파일에 초깃값을
  명시할 수
  없으며, 커넥션이 만들어지는 순간부터 해당 커넥션에서만 유효한 설정 변수를 의미한다


### 정적 변수와 동적 변수
- mysql 서버의 시스템 변수는 디스크에 저장돼 있는 설정 파일(.cnf,.ini)을 변경하는 경우와 이미 기동 중인 mysql 서버의 메모리에 있는  mysql 서버의 시스템 변수를 변경하는 경우로
  구분할 수 있다.
- 디스크에 저장된 설정 파일의 내용이 변경되더라도 mysql 서버가 재시작하기 전에는 적용되지 않는다.
#### mysql 서버에 적용된 변숫값을 정확히 모를때 명령어
```shell
SHOW GLOBAL VARIABLES LIKE '%max_connection%'; 
```
- 위 명령어를 토대로 %문자를 이용해 패턴 검색이 가능

#### mysql 변수 값 변경
```shell
SET GLOBAL max_connections=500;
```
- set 명령어를 통해 my.cnf파일에 반드시 반영되는 것이 아니다. 현재 기동 중인 mysql 인스턴스에만 유효하다.
    - mysql 서버가 재시작되면 설정 파일의 내용은 초기화가 된다
- **영구히 저장할려면 my.cnf파일도 반드시 변경해야하며 8.0 버전부터는 `SET PERSIST` 명령을 이용하면 서버의 시스템 변수를 변경함과 동시에 자동으로 설정 파일로도 기록된다**
- 일반적으로 글로벌 시스템 변수는 서버 기동 중에는 변경할 수 없는 것이 많지만 실시간으로 변경할 수 있는것도 있다.
    1. 변경하고자 하는 값이 동적 변수라면 `SET` 명령으로 간단히 변숫값을 변경할 수 있다. 굳이 재시작을 하지 않아도 된다.
    2. 시스템 변수의 범위가 'Both'(글로벌이면서 세션 변수) 인 경우 글로벌 시스템 변수의 값을 변경해도 이미 존재하는 커넥션의 세션 변수의 값은 변경되지않고 그대로 유지 된다.
- mysql 시스템 변수는 동적인 변수만 SET 명령을 이용해 변경하는 것이 가능하다.
    - 새로운 값을 설정할때 `MB` 나 `GB`와 같이 단위 표기법은 사용할 수 없지만 `2*1024*1024` 와 같은 수식은 사용할 수 있다.

### SET PERSIST
- 8.0 부터 시스템 변수를 변경하면 mysql 서버는 변경된 값을 즉시 적용함과 동시에 별도의 설정파일(myslqd-auto.cnf) 에 변경 내용을 추가로 기록해둔다.
- 서버가 다시 시작될 때 기본 설정 파일(my.cnf) 뿐만 아니라 자동 생성된 파일을 같이 참조해서 시스템 변수를 적용한다.
- SET PERSIST는 세션 변수에는 적용되지 않으며 시스템 변수를 변경하면 mysql 서버는 자동으로 GLOBAL 시스템 변수의 변경으로 인식하고 변경한다.
- 현재 실행 중인 mysql 서버에 바로 변경 내용을 적용하지 않고 다음 재시작 때 mysqld-auto.cnf 파일에만 변경내용을 기록해두고자 한다면 `SET PERSIST_ONLY`명령을 사용하면된다.
- SET PERSIST 명령어나 SET PERSIST_ONLY 명령어를 통해 시스템 변수를 변경하면 JSON 포맷의 mysqld-auto.cnf 파일이 생성된다

#### mysqld-auto.cnf
- 변경된 시스템 변수의 이름과 설정값
- 언제 누구에 의해 시스템 변수가 변경됐는지 등의 정보도 함께 기록된다.
- SET PERSIST 나 SET PERSIST_ONLY 명령으로 추가된 시스템 변수의 내용을 삭제할 때도 있을텐데, 이때 내용을 직접 변경하다가 오률를 만드는 경우 MySQL 서버가 시작되지 못할 수도
  있다. 이때는 `RESET PERSIST` 명령어를 사용하는 것이 안전하다
```shell
## 특정 시스템 변수만 삭제 
mysql> RESET PERSIST max_connections;
mysql > RESET PERSIST IF EXISTS max_connections;

## mysqld-auto.cnf 파일의 모든 시스템 변수를 삭제 
mysql> RESET PERSIST;
```